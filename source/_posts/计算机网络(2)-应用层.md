---
title: 计算机网络(2)-应用层
date: 2022-01-05 22:00:59
tags: 计算机网络
---
## 概述

- 网络应用的原理：网络应用协议的概念和实现方面

  - 传输层的服务模型
  - 客户-服务器模式
  - 对等模式(peer to peer)
  - 内容分发网络
- 网络应用的实例：互联网流行的应用层协议

  - HTTP
  - FTP
  - SMTP/POP3/IMAP
  - DNS
- 编程：网络应用程序

  - Socket API--传输层提供的服务

<!-- more -->

## 协议原理

### 应用架构

- 客户-服务器(C/S)体系结构--达到一定量级后断崖式下降

  - 服务器

    - 一直运行
    - 固定的IP地址和周知的端口号
    - 扩展性：服务器场

      - 数据中心进行扩展
      - 扩展性差
  - 客户端

    - 主动与服务端通信
    - 与互联网有间歇性的连接
    - 可能是动态IP地址
    - 不直接与其他客户端通信
- 对等模式(P2P: Peer To Peer)

  - (几乎)没有一直运行的服务器
  - 任意端系统之间可以进行通信
  - 每一个节点即是客户端又是服务器

    - 自扩展性-新peer节点带来新的服务能力，当然也带来新的服务请求
  - 参与的主机间歇性连接且可以改变IP地址

    - 难以管理
- 混合模式:客户端-服务器和对等体系结构

  - Napster

    - 文件搜索：集中

      - 主机在中心服务器上注册其资源
      - 主机向中心服务器查询资源位置
    - 文件传输：P2P

      - 任意peer节点之间
  - 即时通信

    - 在线检测：集中

      - 当用户上线时，向中心服务器注册其IP地址
      - 用户与中心服务器联系，以找到其在线好友的位置
    - 两个用户之间聊天：P2P

### 进程通信

  进程：在主机上运行的应用程序

- 在同一主机内，使用进程间通信机制通信
- 不同主机，通过交换报文(Message)来通信

  - 使用OS提供的通信服务
  - 按照应用协议交换报文 -- 借助传输层提供的服务
- 具体实现

  - 客户端进程：发起通信的进程
  - 服务器进程：等待连接的进程
- 注意：P2P架构的应用也有客户端进程和服务器进程之分

#### 分布式通信进程

- 存在的问题

  1. 标示和寻址(服务用户)
  2. 传输层-应用层提供服务是如何的(服务)

     - 位置：层间界面的SAP [服务访问点] (TCP/IP：socket)
     - 形式：应用程序接口API(TCP/IP：socket API)
  3. 如何使用传输层提供的服务，实现应用进程之间的报文交换，实现应用(用户使用服务)

     - 定义应用层协议：报文格式，解释，时序等
     - 编制程序，使用OS提供的API，调用网络基础设施提供通信服务传报文，实现应用时序等。
- 解决方法

  1. 对进程进行编址-addressing

     本质上一对主机进程间的通信由2个端节点构成

     - 进程为了接收报文，必须有一个**标识**：**SAP**(发送也需要标示)

       - 主机：唯一的32位IP地址--仅仅有IP地址不能够唯一标示一个进程；在一条端系统上有很多应用进程在运行
       - 传输层协议：TCP或UDP
       - 端口号
     - 一个进程：用IP+port 标示 端节点
  2. 传输层提供的服务--需要穿过层间的信息

     - 层间接口必须要携带的信息

       - 要传输的报文(对于本层来说：SDU)

       - 谁传的：对方的应用进程的标示：IP+TCP(UDP)端口
       - 传给谁：对方的应用进程的标示：对方的IP+TCP(UDP)端口
     - 传输层实体(TCP或者UDP实体)根据这些信息进行TCP报文段(UDP数据报)的封装

       - 源端口号，目标端口号，数据等
       - 将IP地址往下交IP实体，用于封装IP数据报：源IP，目标IP
     - 对于面向连接服务(TCP)的应用而言，套接字是4元组的具有本地意义的标识

       - 4元组(源IP，源port，目标IP，目标port)
       - 唯一的指定了一个会话(2个进程间的会话关系)
       - 应用使用这个标示，与远程的应用进行通信
       - 不必每个报文的发送都要指定这4元组
       - 使用的是类似句柄的存在
       - 便于管理、简单
       - 操作系统需要维护一张表--socket值 4元组+状态
     - UDP socket

       - 2元组 (IP, port 源端指定)
       - 指定了应用所在的一个端节点
       - 在发送数据报时，采用创建好的本地套接字(标示ID)，就不必每个报文中指明自己所采用的ip和port
       - 但是在发送报文时，必须指定对发的ip和UDP port
  3. 使用传输层的提供的服务实现应用

     - 应用层协议--是在应用的一部分
       - 定义了运行在不同端系统上的应用进程如何交换报文

         - 报文类型
         - 报文的类型的语法
         - 字段的语义：即字段取值的含义
         - 进程何时，如何发送报文及对报文进行响应的规则
       - 指标

         - 数据丢失率
         - 延迟
         - 吞吐
         - 安全性
           - 机密性
           - 完整性
           - 可认证性(鉴别)
     - 传输层提供的服务
       - TCP
         - 可靠的传输服务
         - 流量控制
         - 拥塞控制
         - 不能提供的服务：时间保证、最小吞吐保证和安全
         - 面向连接
       - UDP
         - 不可靠
         - 不提供服务：可靠、流量控制、拥塞控制、时间、带宽保证、建立连接
         - 存在的理由
           - 区分不同的进程
           - 无需连接
           - 不做可靠性的工作
           - 应用能够按照设定的速度发送数据
- 安全TCP

  - SSL
    - 在TCP上面实现，提供加密的TCP连接
    - 私密性
    - 数据完整性
    - 端到端的鉴别
    - 在应用层

## Web and HTTP

### 术语

- web页：由一些对象组成
  - 对象可以时HTML文件，JPEG图像，Java小程序，声音剪辑文件
  - web页含有一个基本的HTML文件，该基本HTML文件又包含若干对象的引用
  - 通过URL对每个对象进行引用

    - 访问协议，用户名，口令字，端口等
  - URL格式：

    协议名  用户：口令  主机名        路径名  端口
    Prot：//ueser:psd@www.some.com/xxx.gif:port

### HTTP

- HTTP：超文本传输协议
  - web的应用层协议
  - 客户/服务器模式

    - 客户：请求、接收和显示Web对象的浏览器
    - 服务器：对请求进行响应，发送对象的Web服务器
  - 工作原理：

    - 客户端发起一个与服务器的TCP连接(独立套接字)，端口号为80
    - 服务器接受客户的TCP连接
    - 在浏览器(HTTP客户端)与Web服务器(HTTP服务器server)交换HTTP报文(应用层协议报文)
    - TCP关闭

    注：HTTP是**无状态**的：服务器不维护关于客户的任何信息。无状态的服务器能够支持更多的客户端。
  - HTTP连接

    - 非持久
      - 最多只有一个对象在TCP连接上发送
      - 下载多个对象需要多个TCP连接
      - HTTP/1.0 使用非持久连接
      - 缺点：
        - 每个对象要2个RTT
        - 操作系统必须为每个TCP连接分配资源
        - 但浏览器通常打开并行TCP连接，以获取引用对象
    - 持久
      - 多个对象可以在一个(在客户端和服务器之间)TCP连接上传输
      - HTTP/1.1默认使用持久连接
      - 服务器在发送响应后，仍保持TCP连接
      - 在相同客户端和服务器之间的后续请求和响应报文通过相同的连接进行传递
      - 客户端在遇到一个引用对象的时候，就可以尽快发送该对象的请求
      - 非流水方式的持久HTTP：
        - 客户端只能在收到前一个响应后才能发出新的请求
        - 每个引用对象花费一个RTT
      - 流水方式的持久HTTP
        - HTTP/1.1的默认模式
        - 客户遇到一个引用对象就立即产生一个请求
        - 所有引用对象只花费一个RTT是可能的
  - 响应时间模型

    往返时间RTT(round-trip-time)：一个小的分组从客户端到服务器，在回到客户端的时间
    响应时间：

    - 一个RTT用来发起TCP连接
    - 一个RTT用来HTTP请求并等待HTTP响应
    - 文件传输

    注：共 2RTT+传输时间
  - HTTP请求报文

    - 类型：请求、响应
    - 请求报文：
      ASCII(人能阅读)

      ```http
      请求行（GET、POST、HEAD命令）
      GET /xxx/xxxx/page.html HTTP/1.1
      Host: www.xxx.com
      User-agent: Mozilla/4.0
      Connection：close
      Accept-language:fr
      --换行回车符，表示报文结束--
      请求行
      首部行
      请求体
      ```

      - 提交表单输入方式
        - Post
          1. 网页通常包括表单输入
          2. 包含在实体主体(entity body)中的输入被提交到服务器
        - URL
          1. 方法：GET
          2. 输入通过请求行的URL字段上载
    - 方法类型

      1. HTTP/1.0
         - GET
         - POST
         - HEAD：要求服务器在响应报文中不包含请求对象->故障跟踪
      2. HTTP/1.1
         - GET、POST、HEAD
         - PUT：将实体主体中的文件上载到URL字段规定的路径中
         - DELETE：删除URL字段规定的文件
  - HTTP响应报文

    ```http
    状态行 HTTP/1.1 200 OK\r\n
    首部行:
          Connection close\r\n
          Date:
          Server
          Last-Modified
          Content-Length
          Content-Type
    数据，如请求的HTML文件
    ```
  - 用户-服务器状态：cookies--维护状态

    - 概念：
      - 缓存既是客户端又是服务器
      - 通常缓存是由ISP安装(大学、公司、居民区ISP)
    - 组成部分：
      - 在http响应报文中有一个cookie的首部行
      - 在http请求报文含有一个cookie的首部行
      - 在用户端系统中保留有一个cookie文件，由用户的浏览器管理
      - 在web站点有一个后端数据库
    - 作用
      - 用户验证
      - 购物车
      - 推荐
      - 用户状态（Web e-mail）
    - 如何维持状态
      - 协议端节点：在多个事务上，发送端和接收端维持状态
      - cookies： http报文携带状态信息
    - 存在隐私性问题
  - web cache缓存(代理服务器)

    - 目的：不访问原始服务器，就满足客户的请求

      - 用户设置浏览器：通过缓存访问web
      - 浏览器将所有的HTTP请求发给缓存
        - 在缓存中的对象：缓存直接返回对象
        - 如果对象不在缓存。缓存请求原始服务器，然后再将对象返回给客户端
    - 使用的优点

      1. 降低客户端的请求响应时间
      2. 可以大大减少一个机构内部与Internet接入链路上的流量
      3. 互联网大量采用缓存：可以使较弱的ICP也能够有效提供内容
    - 缓存示例

      ```webcache
      假设：
      平均对象大小 = 100kb
      局域网的带宽为1Gbps
      机构内浏览器对原始服务器的平均请求速率 = 15 请求/s
      平均到浏览器的速率： 1.5Mbps
      机构内部路由器到原始服务器再返回到路由器的延时 = 2s
      接入链路带宽： 1.54 Mbps
      结果：
      LAN的流量强度 = 0.15 %
      接入链路上的流量强度 = 99%
      总延时 = LAN延时 + 接入延时 + Internet延时
      解决方法：
      1.增加接入链路带宽(非常昂贵)
      2.安装本地缓存
        假设0.6需要去访问远程服务器
        速率 = 0.6 * 1.5 = 0.9 Mbps
        接入链路上的流量强度 = 0.9 / 1.54 = 0.58
        总体延迟 = 0.6*（从原始服务器获取对象的延迟）+ 0.4（从缓存获取对象的延迟）
      ```
    - 条件GET获取

      使用Last-Modified来判断缓存是否需要更新。

      - 缓存器在HTTP请求中指定缓存拷贝的日期：

        ```http
          if-modified-since：
            <date>
        ```
      - 服务器：如果对象没变返回下列所述。如果改变则正常返回

        ```http
        HTTP/1.0 304 Not
          Modified
        ```

## FTP

- 向远程主机上传输文件或从远程主机接收文件
- 客户/服务模式
- ftp：RFC959
- ftp服务器：端口号为21.使用TCP作为传输协议（明文传输）
  - 数据传输是通过另一个端口发出
  - 一个是控制端口，一个传输端口(带外传送)
  - ftp服务器维护用户的状态信息：当前路径，用户账户与控制连接对应。
  - 有状态协议
- FTP命令：在控制连接上以ASCII文本方式传送
- 返回码的状态码和状态信息同HTTP

## Email

### SMTP

### POP3

### IMAP

## DNS

## P2P应用

## CDN

## TCP(Socket)编程

## UDP套接字编程

[SDU]: #
